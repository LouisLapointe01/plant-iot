// prisma/schema.prisma — MyLife Platform

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────
// MODULE PHYSIQUE (1 par pot)
// ─────────────────────────────────────────
model Device {
  id              String    @id @default(cuid())
  name            String
  location        String?
  macAddress      String    @unique
  firmwareVersion String?
  isOnline        Boolean   @default(false)
  lastSeen        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  plant           Plant?
  sensorReadings  SensorReading[]
  wateringEvents  WateringEvent[]
  alerts          Alert[]
  config          DeviceConfig?

  @@map("devices")
}

// ─────────────────────────────────────────
// PLANTE ASSOCIÉE AU MODULE
// ─────────────────────────────────────────
model Plant {
  id        String   @id @default(cuid())
  name      String
  species   String?
  imageUrl  String?
  notes     String?
  deviceId  String   @unique
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("plants")
}

// ─────────────────────────────────────────
// CONFIGURATION PAR MODULE
// ─────────────────────────────────────────
model DeviceConfig {
  id                    String  @id @default(cuid())
  deviceId              String  @unique
  device                Device  @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  humidityThresholdLow  Int     @default(30)
  humidityThresholdHigh Int     @default(70)

  wateringDurationSec   Int     @default(5)
  wateringCooldownMin   Int     @default(60)

  readingIntervalMin    Int     @default(30)

  autoWateringEnabled   Boolean @default(true)
  nightModeStart        Int     @default(22)
  nightModeEnd          Int     @default(7)

  reservoirAlertLevel   Int     @default(20)

  updatedAt             DateTime @updatedAt

  @@map("device_configs")
}

// ─────────────────────────────────────────
// LECTURES DES CAPTEURS (time-series)
// ─────────────────────────────────────────
model SensorReading {
  id             String   @id @default(cuid())
  deviceId       String
  device         Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  soilHumidity   Float
  airTemperature Float?
  airHumidity    Float?
  waterLevel     Float?
  batteryLevel   Float?
  rssi           Int?

  recordedAt     DateTime @default(now())

  @@index([deviceId, recordedAt])
  @@index([recordedAt])
  @@map("sensor_readings")
}

// ─────────────────────────────────────────
// ÉVÉNEMENTS D'ARROSAGE
// ─────────────────────────────────────────
model WateringEvent {
  id             String          @id @default(cuid())
  deviceId       String
  device         Device          @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  triggeredBy    WateringTrigger
  durationSec    Int
  humidityBefore Float?
  humidityAfter  Float?
  success        Boolean         @default(true)
  notes          String?

  startedAt      DateTime        @default(now())
  endedAt        DateTime?

  @@index([deviceId, startedAt])
  @@map("watering_events")
}

enum WateringTrigger {
  AUTO
  MANUAL
  SCHEDULE
}

// ─────────────────────────────────────────
// ALERTES
// ─────────────────────────────────────────
model Alert {
  id         String        @id @default(cuid())
  deviceId   String
  device     Device        @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  type       AlertType
  severity   AlertSeverity
  message    String
  value      Float?
  isRead     Boolean       @default(false)
  isResolved Boolean       @default(false)
  resolvedAt DateTime?

  createdAt  DateTime      @default(now())

  @@index([deviceId, createdAt])
  @@index([isRead, createdAt])
  @@map("alerts")
}

enum AlertType {
  RESERVOIR_LOW
  RESERVOIR_EMPTY
  SOIL_TOO_DRY
  SOIL_TOO_WET
  DEVICE_OFFLINE
  PUMP_FAILURE
  BATTERY_LOW
  SENSOR_ERROR
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

// ─────────────────────────────────────────
// PLANNING D'ARROSAGE
// ─────────────────────────────────────────
model WateringSchedule {
  id             String    @id @default(cuid())
  deviceId       String
  name           String
  cronExpression String
  durationSec    Int       @default(5)
  isEnabled      Boolean   @default(true)
  lastRun        DateTime?
  nextRun        DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("watering_schedules")
}

// ─────────────────────────────────────────
// AUTH — NextAuth v5
// ─────────────────────────────────────────

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  transactions  Transaction[]
  healthEntries HealthEntry[]
  tasks         Task[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ─────────────────────────────────────────
// VITRINE — Contacts & Rendez-vous
// ─────────────────────────────────────────

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

model Appointment {
  id        String            @id @default(cuid())
  name      String
  email     String
  phone     String
  date      DateTime
  subject   String
  message   String?
  status    AppointmentStatus @default(PENDING)
  smsSent   Boolean           @default(false)
  createdAt DateTime          @default(now())

  @@index([status, createdAt])
  @@map("appointments")
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String
  smsSent   Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("contact_messages")
}

// ─────────────────────────────────────────
// MAISON — Constantes IoT
// ─────────────────────────────────────────

model HomeReading {
  id         String   @id @default(cuid())
  sensor     String
  value      Float
  unit       String
  location   String?
  recordedAt DateTime @default(now())

  @@index([sensor, recordedAt])
  @@map("home_readings")
}

// ─────────────────────────────────────────
// FINANCES — Budget
// ─────────────────────────────────────────

enum TransactionType {
  INCOME
  EXPENSE
}

model Transaction {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Float
  category    String
  description String?
  type        TransactionType
  date        DateTime
  createdAt   DateTime        @default(now())

  @@index([userId, date])
  @@map("transactions")
}

// ─────────────────────────────────────────
// SANTÉ — Suivi santé / sport
// ─────────────────────────────────────────

model HealthEntry {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weight     Float?
  steps      Int?
  sleepHours Float?
  notes      String?
  date       DateTime
  createdAt  DateTime @default(now())

  @@index([userId, date])
  @@unique([userId, date])
  @@map("health_entries")
}

// ─────────────────────────────────────────
// AGENDA — Tâches
// ─────────────────────────────────────────

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model Task {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  completed Boolean      @default(false)
  dueDate   DateTime?
  priority  TaskPriority @default(MEDIUM)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([userId, completed])
  @@map("tasks")
}
